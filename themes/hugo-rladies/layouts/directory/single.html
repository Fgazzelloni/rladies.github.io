
{{ define "main" }}
<!-- Selects -->
{{ $directory := ( .Scratch.Get "directory" ) }}
{{ $ints := slice }}
{{ $langs := slice }}
{{ $loc := slice }}
{{ $countries := slice }}

{{ range $directory }}
  {{ with .interests }}
      {{ $ints = $ints | append  . }}
    {{ end }}
    
    {{ with .languages }}
      {{ $langs = $langs | append  . }}
    {{ end }}
    
    {{ with .location }}
      {{ $tmp := newScratch }}
      {{ with .country }}
        {{ $tmp.Set "loc" . }}
        {{ $countries = $countries | append  . }}
      {{ end }}
      
      {{ with .state }}
        {{ $tmp.Add "loc" ( . | printf ", %s") }}
      {{ end }}
      
      {{ with .city }}
        {{ $tmp.Add "loc" ( . | printf ", %s") }}
      {{ end }}
      
      {{ $loc = $loc | append  ($tmp.Get "loc") }}
  {{ end }}
{{ end }}
{{ $ints := $ints | uniq | sort }}
{{ $langs := $langs | uniq | sort }}
{{ $loc := $loc | uniq | sort }}
{{ $countries := $countries | uniq | sort }}
<!-- -->

  <div class="entry-content">
		{{ .Content }}
	</div>

  <div class="flex-container" id="directory-content">
    

    <div id="selection">
      
      <div class="input-group w-100">
        <div class="input-group-prepend" for="filter-interests">
          <label class="input-group-text" style="min-width:120px;" >Interests</label>
        </div>
        <select class="custom-select" id="filter-interests" multiple="multiple">
          {{ range $ints }}
            <option value="{{. | urlize }}" >{{.}}</option>
          {{ end }}
        </select>
      </div>
              
      <div class="input-group">
        <div class="input-group-prepend" for="filter-language">
          <label class="input-group-text" style="min-width:120px;" >Languages</label>
        </div>
        <select class="custom-select" id="filter-language" multiple="multiple">
          {{ range $langs }}
              <option value="{{. | urlize }}" >{{.}}</option>
          {{ end }}
        </select>
      </div>
                      
      <div class="input-group">
        <div class="input-group-prepend" for="filter-location">
          <label class="input-group-text" style="min-width:120px;" >Location</label>
        </div>
        <select class="custom-select" id="filter-location" multiple="multiple">
          {{ range $countries }}
            {{ $c := . }}
            <optgroup label="{{$c}}" class="{{$c}}">
            {{ range $loc }}
              {{ $l := findRE (printf "^%s" $c) . }}
              {{ if gt (len $l) 0 }}
                <option value="{{. | urlize }}" >{{ replaceRE (printf "%s, " $c) "" . }}</option>
              {{ end }}
            {{ end }}
            </optgroup>
          {{ end }}
        </select>
      </div>
              
    </div>

    <div class="container expand-grid" id="directory-cards">
        <ul class="justify-content-center row row-xl-2 row-lg-3 row-md-4 row-sm-6 row-9 full-width shuffle-wrapper" id="directory-grid">
          {{ range $name := $.Scratch.Get "dic" | shuffle }}
              {{ $d := index $directory $name }}
              {{ $dir := newScratch }}
              {{ $dir.Set "shuffle" slice }}
              {{ $dir.Set "title" $d.name }} 
              {{ $dir.Add "title" "<span><small>"}}
              {{ with $d.social_media }}
                {{ $some := partial "some.html" (dict "data" . ) }}
                {{ $dir.Add "title" $some }} 
              {{ end }}
              {{ $dir.Add "title" "</small></span>"}}
              
              {{ $dir.Set "subtitle" (printf "<p class=\"text-hide directory-id\">%s</p>" $name) }} 
              {{ with $d.work.title }} 
                {{ $dir.Add "subtitle" . }} 
                {{ $dir.Add "shuffle" . }}
              {{ end }}
              
              {{ $dir.Set "img" "" }}
              {{ with (resources.GetMatch $d.photo.url ) }}
                {{ $image :=  . }}
                {{ $image := $image.Fill "300x300" }}
                {{ $dir.Set "img" $image.RelPermalink }}
              {{ end }}
              
              {{ with $d.interests }}
                {{ $dir.Add "shuffle" . }}
              {{ end }}
              
              {{ with $d.languages }}
                {{ $dir.Add "shuffle" . }}
              {{ end }}
              
              {{ with $d.honorific }}
                {{ $dir.Add "shuffle" . }}
              {{ end }}
              
              {{ with $d.location }}
                {{ $tmp := newScratch }}
                {{ with .country }}
                  {{ $tmp.Set "loc" . }}
                {{ end }}
                
                {{ with .state }}
                  {{ $tmp.Add "loc" ( . | printf ", %s") }}
                {{ end }}
                
                {{ with .city }}
                  {{ $tmp.Add "loc" ( . | printf ", %s") }}
                {{ end }}
                {{ $dir.Add "shuffle" ($tmp.Get "loc")}}
              {{ end }}
              
              {{ $descr := partial "funcs/directory/descr.html" (dict "data" $d "id" $name ) }}
              {{ $subtitle := ($dir.Get "subtitle" ) }}
              {{ $title := ($dir.Get "title" ) }}
              {{ $foot := (partial "funcs/directory/foot.html" $d ) }}
              {{ $shuffle := ( $dir.Get "shuffle" ) }}
              
              {{ partial "funcs/card-expand.html" (dict "title" $title "subtitle" $subtitle "size" "large"  "img" ($dir.Get "img") "category" $d.honorific "descr" $descr "foot" $foot "footcol" 2 "id" $name  "shuffle" $shuffle ) }}
          {{ end }}
      </ul>
    </div>
  </div> 
{{ end }}

{{ define  "footer" }}
{{ if eq hugo.Environment "production" }}
  {{ .Scratch.Set "n_page_directory" 25}}
{{ else }}
  {{ .Scratch.Set "n_page_directory" 5}}
{{ end }} 

<script type="text/javascript">
  $(document).ready(function() {
    $('.custom-select').multiselect({
      includeSelectAllOption: true,
      maxHeight: 300,
      enableFiltering: true,
      enableClickableOptGroups: true,
      enableCollapsibleOptGroups: true
    });
    $('.form-check-input').attr('name', 'shuffle-filter');
  });
</script>
{{ end }}
